<!doctype html>
<html lang="en">
	<meta charset="utf-8">
	<head>
		<script src='https://api.tiles.mapbox.com/mapbox.js/v2.2.1/mapbox.js'></script>
		<link href='https://api.tiles.mapbox.com/mapbox.js/v2.2.1/mapbox.css' rel='stylesheet' />
		<style>
		  body { margin:0; padding:0; }
		  #map { position:absolute; top:0; bottom:0; width:100%; }
		</style>
	</head>
	<body>
		<div id='map'></div>
		<!-- Taffy DB -->
		<script type="text/javascript" src="src/js/taffy-min.js"></script>
		<script>	
		function getData(scope) {
			var columnNames = getWhatToGet(dataFields[scope]);
			var query = 'SELECT ' + columnNames + '  FROM ' + dataTableIDs[scope];
			getFusionTablesData(query, "parseData" + scope);
		}
		function getWhatToGet(columns){
		  	var whatToGet = "";
		  	for (var i = 0; i < columns.length; i++){
		  		whatToGet = whatToGet + columns[i].name + ", ";
		  	}
		  	whatToGet = whatToGet.substring(0, whatToGet.length - 2);
		  	return whatToGet;
	  	}
	  	function getFusionTablesData(query, callback){
		  	var script = document.createElement('script');
		  	var url = ['https://www.googleapis.com/fusiontables/v1/query?'];
		  	url.push('sql=');
		  	var encodedQuery = encodeURIComponent(query);
		  	url.push(encodedQuery);
		  	url.push('&callback=' + callback);
		  	url.push('&key=AIzaSyCyOfjR4LVvpwhsb4UfAT0AINBB19cbfUc');
		  	script.src = url.join('');
		  	var body = document.getElementsByTagName('body')[0];
		  	body.appendChild(script);
	  	} 
	  	function httpGet(theUrl){
		    var xmlHttp = new XMLHttpRequest();
		    xmlHttp.open( "GET", theUrl, false );
		    xmlHttp.send( null );
		    return xmlHttp.responseText;
		}
		function populateColumnNames(){
			for (property in tables) {
	            if (tables.hasOwnProperty(property)) {
					tables[property].columns = getFTcolumnlist(tables[property].id);
	            }
	        }
		}
		function populateTableData(){
			for (property in tables) {
	            if (tables.hasOwnProperty(property)) {
	            	var columns = getWhatToGet(tables[property].columns);
					tables[property].data = getTableData(tables[property].id, columns);
					if(property == "tracker"){
						tables[property].trips = getTripData();
					}
	            }
	        }
		}
		function getFTcolumnlist(tableID){
			var query = "https://www.googleapis.com/fusiontables/v2/tables/" + tableID + "/columns?key=AIzaSyCyOfjR4LVvpwhsb4UfAT0AINBB19cbfUc";
			return parseColumnNames(httpGet(query));
		}
		function getTableData(tableID, whatToGet){
			var query = 'SELECT ' + whatToGet + ' FROM ' + tableID;
			var url = "https://www.googleapis.com/fusiontables/v1/query?sql=" + encodeURIComponent(query) + "&key=AIzaSyCyOfjR4LVvpwhsb4UfAT0AINBB19cbfUc";
			return parseTableData(httpGet(url));
		}
		function parseTableData(response){
			var obj = JSON.parse(response);
			var columns = obj.columns;
			var db = TAFFY();
			var rows = obj.rows;
			for (var j = 0; j < rows.length; j++) {
				var elem = {};
				for (var i = 0; i < columns.length; i++) {
					elem[columns[i]] = rows[j][i];
					if(columns[i] == "Date"){
						var date = Date.parse(rows[j][i]).toString();
						elem.timeStamp = date;
					}
				};
				db.insert(elem);
			};
			return db;
		}
		function parseColumnNames(response){
			var obj = JSON.parse(response);
			var items = obj.items;
			var columns = [];
			for (var i = 0; i < items.length; i++) {
				columns[i] = {};
				columns[i].name = items[i].name;
				columns[i].type = items[i].type;
			};
			return columns;
		}
		function getTripData(){
			var trips = tables.tracker.data().distinct("TripID");
			var tripObj = {};
			console.log("jir");
			for (var i = 0; i < trips.length; i++) {
				tripObj[trips[i]] = {};
			};
			return tripObj;
		}
		function drawTrips(){
			for (property in tables.tracker.trips) {
	            if (tables.tracker.trips.hasOwnProperty(property)) {
	            	drawTrip(property);
	            }
	        }
		}
		function drawTrip(trip){
			query = {};
			query.TripID = trip;
			var trip = tables.tracker.data(query).order("timeStamp").get();
			var points = [];
			for (var i = 0; i < trip.length; i++) {
				var point = [trip[i].Lat, trip[i].Lng];
				points[i] = point;
			};
			var polyline_options = {
			    color: '#000'
			};
			var polyline = L.polyline(points, polyline_options).addTo(map);
		}
	  	var tables = {
	  		"survey":{
	  			id:"1oLI1-lIhigT5Cqn7nTrlYCmzanNgKELpNbfeCBuG"
	  		},
	  		"tracker":{
	  			id:"1cjN7VwSnP2V-0Dbu-KfGBL3hcbMs4zXNcD3EqJU5"
	  		}
	  		,
	  		"trackerStartSurvey":{
	  			id:"1tbElaK8BjzKh58l94wrLXfHhET_Zz74rfnVcg0iq"
	  		},
	  		"trackerEndSurvey":{
	  			id:"14WYPGQNCBpK2omFnO5zMq53UBuwhxcuCoohSQf3d"
	  		}
	  	}
		L.mapbox.accessToken = 'pk.eyJ1IjoiYnV6b2hlcmJlcnQiLCJhIjoibXJXclpEVSJ9.YxiPmO7Q5QZrOGCuOsAYQg';
		var map = new L.mapbox.map('map', 'buzoherbert.mn20inga').setView([1.339, 103.74], 18);
		populateColumnNames();
		populateTableData();
		drawTrips();
		</script>
	</body>
</html>