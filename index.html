<!doctype html>
<html lang="en">
	<meta charset="utf-8">
	<head>
		<style>
		  body { margin:0; padding:0; }
		  #map { position:absolute; top:0; bottom:0; width:100%; }
		</style>
	</head>
	<body>
		<div id='map'></div>
		<!-- Mapbox -->
		<script src='https://api.tiles.mapbox.com/mapbox.js/v2.2.1/mapbox.js'></script>
		<link href='https://api.tiles.mapbox.com/mapbox.js/v2.2.1/mapbox.css' rel='stylesheet' />
		<!-- Taffy DB -->
		<script type="text/javascript" src="src/js/taffy-min.js"></script>
		<!-- Flocktracker -->
		<script type="text/javascript" src="src/js/FlockSON_min.js"></script>
		<script type="text/javascript" src="src/js/FT_pr_mod_min.js"></script>
		<script>	
		function getWhatToGet(columns){
		  	var whatToGet = "";
		  	for (var i = 0; i < columns.length; i++){
		  		whatToGet = whatToGet + columns[i].name + ", ";
		  	}
		  	whatToGet = whatToGet.substring(0, whatToGet.length - 2);
		  	return whatToGet;
	  	}
	  	function httpGet(theUrl){
		    var xmlHttp = new XMLHttpRequest();
		    xmlHttp.open( "GET", theUrl, false );
		    xmlHttp.send( null );
		    return xmlHttp.responseText;
		}
		function populateColumnNames(){
			for (property in tables) {
	            if (tables.hasOwnProperty(property)) {
					tables[property].columns = getFTcolumnlist(tables[property].id);
	            }
	        }
		}
		function populateTableData(){
			for (property in tables) {
	            if (tables.hasOwnProperty(property)) {
	            	var columns = getWhatToGet(tables[property].columns);
					tables[property].data = getTableData(tables[property].id, columns);
					if(property == "tracker"){
						tables[property].trips = getTripData();
					}
	            }
	        }
		}
		function getFTcolumnlist(tableID){
			var query = "https://www.googleapis.com/fusiontables/v2/tables/" + tableID + "/columns?key=AIzaSyCyOfjR4LVvpwhsb4UfAT0AINBB19cbfUc";
			return parseColumnNames(httpGet(query));
		}
		function getProject(projectName){
			var query = 'SELECT survey_json FROM ' + projectsTableID + " WHERE table_id='" + projectName + "'";
			var url = "https://www.googleapis.com/fusiontables/v1/query?sql=" + encodeURIComponent(query) + "&key=AIzaSyCyOfjR4LVvpwhsb4UfAT0AINBB19cbfUc";
			var response = JSON.parse(httpGet(url));
			var projectLB = new FT_pr()
			var project = new projectLB.project();
			project.deserializeJSON(response.rows[0][0]);
			return project;
		}
		function getTableData(tableID, whatToGet){
			var query = 'SELECT ' + whatToGet + ' FROM ' + tableID;
			var url = "https://www.googleapis.com/fusiontables/v1/query?sql=" + encodeURIComponent(query) + "&key=AIzaSyCyOfjR4LVvpwhsb4UfAT0AINBB19cbfUc";
			return parseTableData(httpGet(url));
		}
		function parseTableData(response){
			var obj = JSON.parse(response);
			var columns = obj.columns;
			var db = TAFFY();
			var rows = obj.rows;
			for (var j = 0; j < rows.length; j++) {
				var elem = {};
				for (var i = 0; i < columns.length; i++) {
					elem[columns[i]] = rows[j][i];
					if(columns[i] == "Date"){
						var date = Date.parse(replaceAll("-", "/", rows[j][i])).toString();
						elem.timeStamp = date;
					}
				};
				db.insert(elem);
			};
			return db;
		}
		function parseColumnNames(response){
			var obj = JSON.parse(response);
			var items = obj.items;
			var columns = [];
			for (var i = 0; i < items.length; i++) {
				columns[i] = {};
				columns[i].name = items[i].name;
				columns[i].type = items[i].type;
			};
			return columns;
		}
		function getTripData(){
			var trips = tables.tracker.data().distinct("TripID");
			var tripObj = {};
			for (var i = 0; i < trips.length; i++) {
				tripObj[trips[i]] = {};
				query = {};
				query.TripID = trips[i];				
				var trip = tables.tracker.data(query).order("timeStamp").get();
				var points = [];
				for (var j = 0; j < trip.length; j++) {
					var point = [trip[j].Lat, trip[j].Lng];
					points[j] = point;
				};
				tripObj[trips[i]].points = points;
			};
			return tripObj;
		}
		function drawTrips(){
			for (property in tables.tracker.trips) {
	            if (tables.tracker.trips.hasOwnProperty(property)) {
					drawTrip(property);
	            }
	        }
		}
		function drawTrip(trip){
			var polyline_options = {
			    color: '#000'
			};
			tables.tracker.trips[trip].line = L.polyline(tables.tracker.trips[trip].points, polyline_options).addTo(map);
		}
		function replaceAll(find, replace, str) {
		  return str.replace(new RegExp(find, 'g'), replace);
		}
	  	var tables = {
	  		"survey":{
	  			id:"1oLI1-lIhigT5Cqn7nTrlYCmzanNgKELpNbfeCBuG"
	  		},
	  		"tracker":{
	  			id:"1cjN7VwSnP2V-0Dbu-KfGBL3hcbMs4zXNcD3EqJU5"
	  		}
	  		,
	  		"trackerStartSurvey":{
	  			id:"1tbElaK8BjzKh58l94wrLXfHhET_Zz74rfnVcg0iq"
	  		},
	  		"trackerEndSurvey":{
	  			id:"14WYPGQNCBpK2omFnO5zMq53UBuwhxcuCoohSQf3d"
	  		}
	  	}
	  	var projectsTableID = "1ozk50GfhDEchXBiPwnmMZ1pTdEtGJmmJPq3zK704";
		L.mapbox.accessToken = 'pk.eyJ1IjoiYnV6b2hlcmJlcnQiLCJhIjoibXJXclpEVSJ9.YxiPmO7Q5QZrOGCuOsAYQg';
		var map = new L.mapbox.map('map', 'buzoherbert.mn20inga').setView([1.339, 103.74], 18);
		var project = getProject("walk_proto");
		populateColumnNames();
		populateTableData();
		drawTrips();
		</script>
	</body>
</html>